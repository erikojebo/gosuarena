@using System.Web.Optimization

@model IList<GosuArena.Models.Match.BotModel>

@{
    ViewBag.Title = "Play match!";
}

@section styles
{
    <link rel="stylesheet" href="@Url.Content("~/Content/Match/Play.less")" />
}

@section scripts {
    <script type="text/javascript" src="@Url.Content("~/Scripts/lib/knockout/knockout-3.0.0.js")"> </script>
    <script type="text/javascript" src="@Url.Content("~/Scripts/Pages/Match/Play/botViewModel.js")"> </script>
    <script type="text/javascript" src="@Url.Content("~/Scripts/Pages/Match/Play/matchViewModel.js")"> </script>
    <script type="text/javascript" src="@Url.Content("~/Scripts/Pages/Match/Play/match.js")"> </script>
}

<div id="playing-field">
    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <form class="options">
        <label for="showBotNames">Show bot names</label>
        <input id="showBotNames" type="checkbox" name="showBotNames" />

        <label for="showBotSights">Show bot sights</label>
        <input id="showBotSights" type="checkbox" name="showBotSights" />
    </form>

    <menu class="actions">
        <button id="restartMatch">Restart match</button>
        <button id="stopMatch">Stop match</button>
    </menu>
</div>

<ul id="botLegends" data-bind="foreach: botLegends">
    <li data-bind="css: { killed: !isAlive() }">
        <div class="health" data-bind="style: { height: health() + '%' }"></div>
        <div class="color" data-bind='style: { backgroundColor : color }'></div>
        <span class="name" data-bind="text: name"></span>
    </li>
</ul>

@Scripts.Render("~/bundles/gosuarena")

@foreach (var bot in Model.Where(x => !string.IsNullOrWhiteSpace(x.Script)))
{
    <script type="text/javascript">
        // @bot.Name.ToUpper()
        // A few lines of code have been added to the bot definition, to make it
        // play nice with the framework. The code written by the user can be seen a few lines below
        gosuArena.initiateBotRegistration({
            id: @bot.Id,
            name: "@bot.Name"
        }, function() {
            // Redefine globals
            var window = {};
            var document = {};
            var alert = function() { };
            var XMLHttpRequest = function() { };
            var jQuery = function () { };
            var $ = function () { };

            // User written code starts here:
            
            @Html.Raw(bot.GetScriptToRender(User))
            
            // User written code ends here
        });
    </script>
}

<script type="text/javascript">
    
    gosuArena.sprites = gosuArena.sprites || {};

    function loadSprite(name, url) {
        var img = new Image();

        img.onload = function () {
            gosuArena.sprites[name] = img;
        };

        img.src = url;
    }

    loadSprite('background', '@Url.Content("~/Content/images/map.jpg")');
    loadSprite('wallNorth', '@Url.Content("~/Content/images/wall_north.png")');
    loadSprite('wallSouth', '@Url.Content("~/Content/images/wall_south.png")');
    loadSprite('wallEast', '@Url.Content("~/Content/images/wall_east.png")');
    loadSprite('wallWest', '@Url.Content("~/Content/images/wall_west.png")');
    loadSprite('wallCornerLeft', '@Url.Content("~/Content/images/wall_corner_left.png")');
    loadSprite('wallCornerRight', '@Url.Content("~/Content/images/wall_corner_right.png")');
    loadSprite('bot', '@Url.Content("~/Content/images/mech.png")');
</script>